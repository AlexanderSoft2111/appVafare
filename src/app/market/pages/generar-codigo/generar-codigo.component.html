
<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title><strong>Generar Código</strong></ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <ion-grid fixed>
      <!-- Selección -->
      <ion-row>
        <ion-col size="12" sizeMd="8">

          <!-- Datos del producto -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>1) Datos del producto</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <div class="grid-2">

                <mat-form-field appearance="outline">
  <mat-label>Código de barras / SKU</mat-label>
  <input
    matInput
    formControlName="codigo"
    maxlength="13"
    placeholder="EAN-13 (12 dígitos) o SKU"
    #codigoInput
    (keydown.enter)="codigoInput.blur()"
  />

  <!-- Requerido -->
   @if (form.get('codigo')?.hasError('required') && form.get('codigo')?.touched) {     
     <mat-error>
       El código es <strong>obligatorio</strong>
     </mat-error>
   }

   @if (form.get('codigo')?.hasError('codigoDuplicado')) {     
     <!-- Duplicado -->
     <mat-error>
       El código <strong>ya existe</strong> en Inventario
     </mat-error>
   }

   @if (form.get('codigo')?.pending) {     
     <!-- Validando -->
     <mat-hint>Validando código…</mat-hint>
   }
</mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Nombre</mat-label>
                  <input matInput formControlName="nombre">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Descripción</mat-label>
                  <input matInput formControlName="descripcion">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Stock</mat-label>
                  <input type="number" step="0.01" matInput formControlName="stock">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>PVP</mat-label>
                  <input type="number" step="0.01" matInput formControlName="pvp">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Costo de compra</mat-label>
                  <input type="number" step="0.01" matInput formControlName="costo_compra">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Stock minimo</mat-label>
                  <input type="number" matInput formControlName="stock_minimo">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Fecha de caducidad (opcional)</mat-label>
                  <input type="date" matInput formControlName="fecha_caducidad">
                </mat-form-field>
              </div>
            </ion-card-content>
          </ion-card>

          <!-- Parámetros de la etiqueta -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>2) Parámetros de la etiqueta</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <div class="grid-2">
                <mat-form-field appearance="outline">
                  <mat-label>Tamaño (ancho mm)</mat-label>
                  <input type="number" matInput formControlName="sizeW">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Tamaño (alto mm)</mat-label>
                  <input type="number" matInput formControlName="sizeH">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Tipo de código</mat-label>
                  <mat-select formControlName="tipoCodigo">
                    <mat-option value="CODE128">Code128</mat-option>
                    <mat-option value="EAN13">EAN-13</mat-option>
                    <mat-option value="QR">QR</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Cantidad</mat-label>
                  <input type="number" matInput formControlName="cantidad">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>URL para QR (opcional)</mat-label>
                  <input matInput formControlName="qrUrl">
                </mat-form-field>

                <div class="row-2">
                  <mat-form-field appearance="outline">
                    <mat-label>Oscuridad (MD)</mat-label>
                    <input type="number" matInput formControlName="darkness">
                  </mat-form-field>
                  <mat-form-field appearance="outline">
                    <mat-label>Velocidad (PR)</mat-label>
                    <input type="number" matInput formControlName="speed">
                  </mat-form-field>
                </div>
              </div>

<!--               <div class="actions">
                <button mat-stroked-button
                        (click)="soloImprimir()"
                        [disabled]="cargando || form.pending || form.invalid">
                  Solo generar etiquetas
                </button>

                <button mat-flat-button color="primary"
                        (click)="guardarEImprimir()"
                        [disabled]="cargando || form.pending || form.invalid">
                  Guardar + imprimir
                </button>
              </div> -->

              <div class="actions">
  <button mat-stroked-button
          type="button"
          (click)="soloImprimir()"
          [disabled]="cargando || form.pending || !puedeSoloImprimir">
    Solo generar etiquetas
  </button>

  <button mat-flat-button color="primary"
          type="submit"
          [disabled]="cargando || form.pending || !puedeGuardarEImprimir">
    Guardar + imprimir
  </button>
</div>

            </ion-card-content>
          </ion-card>
        </ion-col>

        <!-- Vista previa (muestra el ZPL; si quieres, renderiza canvas) -->
<!--         <ion-col size="12" sizeMd="4">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Vista previa (ZPL)</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <pre class="zpl-preview">{{ vistaPreviaZpl() }}</pre>
              <p class="muted">* Sugerencia: deja 50×30 mm (203 dpi). Ajusta MD/PR si el contraste/velocidad no es óptimo.</p>
            </ion-card-content>
          </ion-card>
        </ion-col> -->
      
      <ion-col size="12" sizeMd="4">
  <ion-card>
    <ion-card-header>
      <ion-card-title>Vista previa (60×40 mm)</ion-card-title>
    </ion-card-header>
    <ion-card-content class="preview-center">
      <app-preview-etiqueta
        [config]="previewConfig()"
        [producto]="previewProducto()">
      </app-preview-etiqueta>

    </ion-card-content>
  </ion-card>
</ion-col>

      
      </ion-row>
    </ion-grid>
  </form>
</ion-content>
