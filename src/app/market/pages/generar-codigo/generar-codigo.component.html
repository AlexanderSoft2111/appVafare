<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Generar Código + Crear Producto</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <form [formGroup]="form">
    <ion-grid fixed>

      <!-- 1) Selección -->
      <ion-row>
        <ion-col size="12" sizeMd="8">
<!--           <ion-card>
            <ion-card-header>
              <ion-card-title>1) Selección</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <mat-radio-group [value]="modo" (change)="modo = $event.value">
                <mat-radio-button value="nuevo">Nuevo producto</mat-radio-button>
                <mat-radio-button value="existente" class="ml-3">Producto existente</mat-radio-button>
              </mat-radio-group>

              <div class="search-row">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-label>Buscar producto existente…</mat-label>
                  <input matInput formControlName="buscar" placeholder="Por código/SKU">
                  <button mat-stroked-button type="button" (click)="buscarProductoExistente()" [disabled]="modo==='nuevo'">
                    Buscar
                  </button>
                </mat-form-field>
                @if (modo==='nuevo') {
                  <small class="muted">Deshabilitado: estás en modo “Nuevo”.</small>
                }
              </div>
            </ion-card-content>
          </ion-card> -->

          <!-- 2) Datos del producto -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>2) Datos del producto</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <div class="grid-2">
                <mat-form-field appearance="outline">
                  <mat-label>Código de barras / SKU</mat-label>
                  <input matInput formControlName="codigo" maxlength="13" (blur)="validarCodigoUnico()">
                  <mat-hint>EAN-13 (12 dígitos) o SKU alfanumérico</mat-hint>

                  @if (form.get('codigo')?.hasError('required')) {
                  <mat-error >Requerido</mat-error>
                  }

                  @if (form.get('codigo')?.hasError('codigoDuplicado')) {
                  <mat-error >Ya existe un producto con este código</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Nombre</mat-label>
                  <input matInput formControlName="nombre">
                  @if (form.get('nombre')?.hasError('required')) {
                    <mat-error>Requerido</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Descripción</mat-label>
                  <input matInput formControlName="descripcion">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Categoría</mat-label>
                  <input matInput formControlName="categoria">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>PVP</mat-label>
                  <input type="number" step="0.01" matInput formControlName="pvp">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Costo de compra</mat-label>
                  <input type="number" step="0.01" matInput formControlName="costo_compra">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Stock inicial</mat-label>
                  <input type="number" matInput formControlName="stock">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Fecha de caducidad (opcional)</mat-label>
                  <input type="date" matInput formControlName="fecha_caducidad">
                </mat-form-field>
              </div>

              <mat-radio-group [value]="modo" (change)="setModo($event.value)">
                <mat-radio-button value="nuevo">Nuevo producto</mat-radio-button>
                <mat-radio-button value="existente" class="ml-3">Producto existente</mat-radio-button>
              </mat-radio-group>

              <mat-slide-toggle formControlName="crearInventario">
                Crear este producto en Inventario al imprimir
              </mat-slide-toggle>

            </ion-card-content>
          </ion-card>

          <!-- 3) Parámetros de la etiqueta -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>3) Parámetros de la etiqueta</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <div class="grid-2">
                <mat-form-field appearance="outline">
                  <mat-label>Ancho (mm)</mat-label>
                  <input type="number" matInput formControlName="sizeW">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Alto (mm)</mat-label>
                  <input type="number" matInput formControlName="sizeH">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Tipo de código</mat-label>
                  <mat-select formControlName="tipoCodigo">
                    <mat-option value="CODE128">Code128</mat-option>
                    <mat-option value="EAN13">EAN-13</mat-option>
                    <mat-option value="QR">QR</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Cantidad</mat-label>
                  <input type="number" matInput formControlName="cantidad">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>URL para QR (opcional)</mat-label>
                  <input matInput formControlName="qrUrl">
                </mat-form-field>

                <div class="row-2">
                  <mat-form-field appearance="outline">
                    <mat-label>Oscuridad (MD)</mat-label>
                    <input type="number" matInput formControlName="darkness">
                  </mat-form-field>
                  <mat-form-field appearance="outline">
                    <mat-label>Velocidad (PR)</mat-label>
                    <input type="number" matInput formControlName="speed">
                  </mat-form-field>
                </div>
              </div>

              <div class="actions">
                <button mat-stroked-button type="button" (click)="soloImprimir()">Solo imprimir</button>
                <button mat-flat-button color="primary" type="button" [disabled]="isSaving" (click)="guardarEImprimir()">Guardar + imprimir</button>
              </div>

              @if (mensaje) {
                <div class="msg">{{ mensaje }}</div>
              }
            </ion-card-content>
          </ion-card>
        </ion-col>

        <!-- Vista previa (ZPL) -->
        <ion-col size="12" sizeMd="4">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Vista previa Etiqueta</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <preview-etiqueta
               [nombreFull]="form.value.nombre || ''"
               [descripcionFull]="form.value.descripcion || ''"
               [pvp]="form.value.pvp || 0"
               [codigo]="form.value.codigo || ''"

               [format]="px.format"
               [sizeWmm]="form.value.sizeW || defaultSize.w"
               [sizeHmm]="form.value.sizeH || defaultSize.h"

               [barWidthPx]="px.barWidthPx"
               [barHeightPx]="px.barHeightPx">
             </preview-etiqueta>
            </ion-card-content>
          </ion-card>
          <ion-card>
          </ion-card>
        </ion-col>

      </ion-row>


    </ion-grid>
  </form>
</ion-content>
