

<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title><strong>Inventario</strong></ion-title>
    <ion-buttons slot="end">
      <ion-chip color="dark" (click)="cargarProductos()">
        <ion-label>Actualizar</ion-label>
        <ion-icon name="refresh-circle"></ion-icon>
      </ion-chip>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">

  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large"><strong>Inventario</strong> </ion-title>
    </ion-toolbar>
  </ion-header>



  <div class="p-4">

    <ion-grid class="top-actions-grid" fixed>
      <ion-row class="ion-align-items-center ion-justify-content-between">
        <!-- izquierda -->
        <ion-col size="12" sizeMd="auto">
          <button (click)="addProduct()" class="btnCliente" style="background: none; border: none;">
            <ion-item button class="none" lines="none" detail="false" class="button-next">
              <ion-label class="normal font-weight-bold">
                Añadir Producto
              </ion-label>
              <ion-buttons slot="end">
                <ion-button>
                  <ion-icon slot="icon-only" name="add-circle-sharp"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-item>
          </button>
        </ion-col>


            <ion-col size="12" sizeMd="auto" class="filters">
              <ion-segment [value]="filterState.mode" (ionChange)="onModeChange($event)">
                <ion-segment-button value="all">Todos</ion-segment-button>
                <ion-segment-button value="expiry">Caducados</ion-segment-button>
                <ion-segment-button value="stock">Agotados</ion-segment-button>
              </ion-segment>

            </ion-col>
          </ion-row>
        </ion-grid>

        <ion-item>
          <ion-icon slot="start" name="options"></ion-icon>
          <ion-input placeholder="Buscar por Nombre, descripción o código" (ionInput)="onSearch($event)"></ion-input>
            @if (!vendedor) {
              <ion-chip
                slot="end"
                class="chip-toggle"
                (click)="toggleCosts()"
                [color]="showCosts ? 'success' : 'medium'">
                <ion-label>{{ showCosts ? 'Ocultar costos' : 'Ver costos' }}</ion-label>
              </ion-chip>
            }
        </ion-item>


        @if (loading) {
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        }

        <div class="mat-elevation-z8">

          <table mat-table [dataSource]="dataSource!" matSort >

            <!-- editar -->
            <ng-container matColumnDef="editar">
              <th mat-header-cell *matHeaderCellDef mat-sort-header></th>
              <td mat-cell *matCellDef="let row">
                <ion-buttons>
                  <ion-button (click)="setProduct(row)">
                    <ion-icon slot="icon-only" name="create"></ion-icon>
                  </ion-button>
                  <ion-button (click)="copyCodigo(row)">
                    <ion-icon slot="icon-only" name="copy"></ion-icon>
                  </ion-button>
                  @if (!vendedor) {
                    <ion-button (click)="delete(row)">
                      <ion-icon color="danger" slot="icon-only" name="trash"></ion-icon>
                    </ion-button>
                  }
                </ion-buttons>
              </td>
            </ng-container>


            <!-- Nombre -->
<!--             @for (campo of campos; track $index) {
              <ng-container [matColumnDef]="campo.campo">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> {{campo.label}} </th>
                <td (click)="setStock($event,row)" mat-cell *matCellDef="let row"> {{row[campo.campo]}} </td>
              </ng-container>

            } -->

              <!-- Contenedores de datos (incluye costo_* para admin) -->
              @for (campo of campos; track $index) {
                <ng-container [matColumnDef]="campo.campo">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ campo.label }} </th>

                  <!-- Click para editar stock SOLO en la columna 'stock' y SOLO si es admin -->
                  <td mat-cell *matCellDef="let row"
                      (click)="campo.campo === 'stock' && !vendedor && setStock($event, row)">
                    {{ row[campo.campo] }}
                  </td>
                </ng-container>
              }

              <!-- Usa el getter 'columns' -->
              <tr style="background:#e3edff" mat-header-row *matHeaderRowDef="columns"></tr>
              <tr mat-row
                  *matRowDef="let row; columns: columns"
                  tabindex="0" role="button"
                  (mouseenter)="hovered = row" (mouseleave)="hovered = null"
                  (focus)="hovered = row" (blur)="hovered = null"
                  (click)="selected = row"
                  [ngClass]="[getRowClass(row), hovered === row ? 'is-hover' : '', selected === row ? 'is-selected' : '']">
              </tr>

            <!-- Row shown when there is no matching data. -->
            <tr class="mat-row" *matNoDataRow >
              <td class="mat-cell" colspan="4">Ninguna coincidencia con "{{filterState.term}}"</td>
            </tr>
          </table>

          <mat-paginator [pageSizeOptions]="[10, 25, 50]" [pageSize]="25"></mat-paginator>
        </div>
  </div>


  </ion-content>

