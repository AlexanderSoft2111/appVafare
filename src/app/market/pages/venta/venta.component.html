<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title><strong>Nueva venta</strong></ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="saveVenta()">
        <ion-icon slot="icon-only" name="save" color="dark"></ion-icon>
      </ion-button>
      <ion-button (click)="resetVenta()" aria-label="Eliminar">
        <ion-icon  slot="icon-only" name="close-circle" color="danger"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>


<ion-content [fullscreen]="true">

  <ion-grid>
    <ion-row class="ion-justify-content-between">
      @if (venta) {
        <ion-col class="mat-elevation-z8" size="6">
          <ion-item>

            <mat-form-field class="full-width">
              <input type="text"
                    matInput
                    [formControl]="clienteControl"
                    [matAutocomplete]="auto"
                    placeholder="Nombre o cédula" />
              <mat-icon matSuffix>search</mat-icon>

              <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn" (optionSelected)="seleccionarCliente($event.option.value)">
                @for (option of clientesFiltrados$ | async; track option.id) {
                  <mat-option [value]="option">
                    {{ option.nombre }}
                  </mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>

          </ion-item>

            <ion-item lines="none" class="none">
              <ion-label>
                <p> <strong>Nombre:</strong> {{venta.cliente.nombre}}</p>
                <p> <strong>Ruc/CI:</strong> {{venta.cliente.ruc}}</p>
                <p> <strong>Teléfono:</strong> {{venta.cliente.telefono}}</p>
                <p> <strong>Dirección:</strong> {{venta.cliente.direccion}}</p>
                <p> <strong>Correo:</strong> {{venta.cliente.email}}</p>
              </ion-label>
            </ion-item>
        </ion-col>
      }

      @if (venta) {
        <ion-col class="mat-elevation-z8" size="5">
            <ion-item>
              <ion-label> <strong>Venta:</strong></ion-label>
            </ion-item>
            <ion-item lines="none" class="none">
              <ion-label>
                <p> <strong>Fecha:</strong> {{venta.fecha | date:'medium'}}</p>
                <p> <strong>Número:</strong> {{ venta.numero }}</p>
              </ion-label>
            </ion-item>
            <div class="content-total">
              <h3 class="total">${{venta.total.toFixed(2)}}</h3>
            </div>
        </ion-col>
      }

    </ion-row>
    <ion-row>
      <ion-col size="12" class="mat-elevation-z8 mt-4" >
        <ion-item>
          <ion-label> <strong>Productos:</strong>
          </ion-label>
          <ion-buttons slot="end">
            <ion-button (click)="addProductoRapido()">
              <ion-icon slot="icon-only" color="success" name="add-circle"></ion-icon>
            </ion-button>
            <ion-button [routerLink]="['/market/addinventario']" routerLinkActive="router-link-active" >
              <ion-icon slot="icon-only" color="primary" name="create"></ion-icon>
            </ion-button>
            <ion-button [routerLink]="['/market/inventario']" routerLinkActive="router-link-active" >
              <ion-icon slot="icon-only" color="dark" name="search"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-item>

      <div style="overflow-y: auto; height: 300px;">
          @if (venta) {
            <ion-grid>
              <ion-row class="ion-justify-content-between">
                @for (encabezado of encabezados; track $index) {
                  <ion-col class="text-center">
                      <p> <strong>{{encabezado}}</strong>  </p>
                  </ion-col>
                }
              </ion-row>

              @for (producto of venta.productos; track $index; let i = $index) {
                <ion-row class="ion-justify-content-between">
                    <ion-col class="text-center ">
                          <ion-input class="text-center codigo"
                             [(ngModel)]="producto.producto.codigo"
                             (keyup)="onKeyupCodigo(i)"
                             (keydown.enter)="onEnterCodigo(i)">
                          </ion-input>
                    </ion-col>

                    <ion-col  class="text-center">
                      <p> <strong>{{producto.producto.nombre}}</strong>  </p>
                    </ion-col>
                    <ion-col  class="text-center">
                      <p> <strong>{{producto.producto.stock}}</strong>  </p>
                    </ion-col>
                    <ion-col  class="text-center qty-col">

                        <ion-icon name="trash" color="danger" (click)="eliminarProducto(i)"></ion-icon>
                        <ion-icon class="icon-remove" name="remove" (click)="removeCantidad(producto)"></ion-icon>
                        <ion-input class="text-center cantidad" type="number" step="1" min="0"
                        [(ngModel)]="producto.cantidad"
                        (ionChange)="changeCantidad(producto, i)">
                        </ion-input>
                        <ion-icon class="icon-add" name="add" (click)="addCantidad(producto)"></ion-icon>

                    </ion-col>


                    <ion-col  class="text-center">
                      <p> <strong>${{producto.producto.pvp}}</strong>  </p>
                    </ion-col>

                    <ion-col class="text-center">
                      <p> <strong>${{(producto.precio).toFixed(2)}}</strong>  </p>
                    </ion-col>
                </ion-row>
              }

            </ion-grid>
          }
        </div>



      </ion-col>
    </ion-row>
  </ion-grid>

</ion-content>

<ion-footer>
  <div class="mat-elevation-z8 m-1">
      <ion-grid >
        <ion-row>
          <ion-col>
            <ion-item>
              <ion-label> <strong>Valores:</strong>
              </ion-label>
            </ion-item>
          </ion-col>
        </ion-row>

        @if (venta) {
          <ion-row class="ion-align-items-center ion-justify-content-between">
            <ion-col>
                  <ion-item class="none content-total ">
                    <ion-label class="pago">Pago:
                    </ion-label>
                    <ion-input [(ngModel)]="pago" class="m-2 vuelto-input"
                    type="number" (ionChange)="changePago()"></ion-input>
                  </ion-item>
            </ion-col>

            <ion-col>
              <ion-item class="none content-total">
                <ion-label class="pago">Vuelto: ${{vuelto.toFixed(2)}}
                </ion-label>
              </ion-item>
            </ion-col>

            <ion-col>
              <ion-item class="none text-right" lines="none" detail="false">
                  <ion-label class="normal">
                      <p class="m-0"> <strong>Subtotal sin IVA:</strong> ${{venta.subtotal_sin_iva.toFixed(2)}}</p>
                      <p class="m-0"> <strong>IVA:</strong> ${{venta.iva.toFixed(2)}}</p>
                      <p class="m-0"> <strong>Total:</strong> ${{venta.total.toFixed(2)}}</p>
                  </ion-label>

                  <ion-button (click)="imprimir()">probar</ion-button>
              </ion-item>
            </ion-col>
          </ion-row>
        }
      </ion-grid>
  </div>
</ion-footer>
